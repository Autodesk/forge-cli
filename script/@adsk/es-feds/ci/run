#!/bin/bash

##
## WARNING THIS FILE WAS GENERATED BY @adsk/es-feds. Do not modify.
## These files SHOULD be committed to git so jenkins can use them
##

# the name of the compose project
# git rev-parse HEAD busts the cache any time
# the commit changes
# WARNING!: if running locally the Docker container will only be rebuilt when this changes
PROJECT_NAME="es-feds-$(git rev-parse HEAD)"

# the service in docker-compose.yml that we want to build
SERVICE_NAME="ci"

# the build command to run when the docker container is ready
BUILD_CMD="$1"

# required to calculate the relative path to the DOCKER_FILE and COMPOSE_FILE
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
DOCKER_CONTEXT=$(pwd)
ES_FEDS_PATH=$(python   -c "import os.path; print os.path.relpath('$DIR', '$DOCKER_CONTEXT')")

DOCKER_FILE=$(python $ES_FEDS_PATH/generate-docker-file.py)
COMPOSE_FILE="$ES_FEDS_PATH/docker-compose.yml"

echo "Setting Docker context to $DOCKER_CONTEXT"
echo "Building $PROJECT_NAME"

# # set the env so docker-compose.yml can pick up file & context location
ENV="DOCKER_FILE=$DOCKER_FILE DOCKER_CONTEXT=$DOCKER_CONTEXT"

# pull the cached service image
eval "$ENV docker-compose \
  --file $COMPOSE_FILE \
  --project $PROJECT_NAME \
  pull"

# run the command
eval "$ENV docker-compose \
  --file $COMPOSE_FILE \
  --project $PROJECT_NAME \
  run -e CI=true -T --rm $SERVICE_NAME $BUILD_CMD"
